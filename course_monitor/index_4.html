<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Degree Progress Tracker | Computer Science</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6; /* A very light, soft gray */
        }
        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        th {
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280; /* text-gray-500 */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        td {
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 1rem;
            padding-bottom: 1rem;
            font-size: 0.875rem;
            color: #1f2937; /* text-gray-800 */
            white-space: nowrap;
        }
        td input {
            width: 4rem;
            padding: 0.5rem;
            text-align: center;
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem;
            outline: none;
        }
        td input:focus {
            border-color: #6366f1; /* border-indigo-500 */
            box-shadow: 0 0 0 2px #6366f1; /* focus:ring-indigo-500 */
        }
        .tab-button.active {
            background-color: #4f46e5; /* bg-indigo-600 */
            color: #fff;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.1); /* shadow-lg */
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">

        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">CS Degree Performance Dashboard</h1>
            <p class="mt-1 text-lg text-gray-600">Monitor your 100-Level performance and track your cumulative CGPA.</p>
        </header>

        <!-- View Selector Tabs -->
        <div class="mb-8 flex space-x-2 p-1 bg-gray-200 rounded-xl max-w-lg">
            <button id="tab-sessional" class="tab-button active flex-1 py-2 px-4 rounded-xl font-semibold text-sm transition" onclick="switchView('sessional')">
                100L Sessional Monitor
            </button>
            <button id="tab-degree" class="tab-button flex-1 py-2 px-4 rounded-xl font-semibold text-sm transition" onclick="switchView('degree')">
                Full Degree Progress (100L-400L)
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column: Controls & Summary -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- Export and Controls Card -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Actions & Controls</h2>
                    
                    <div id="sessional-controls">
                        <label for="semester-select" class="block text-sm font-medium text-gray-700 mb-2">Select Semester for Monitor View</label>
                        <select id="semester-select" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="100-omega" selected>100 Level - Omega Semester (2nd)</option>
                            <option value="100-alpha">100 Level - Alpha Semester (1st)</option>
                        </select>
                    </div>

                    <!-- Export Button - Exports ALL 8 semesters regardless of view -->
                    <button id="export-button" onclick="exportResultsToCSV()" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg mt-4 hover:bg-indigo-700 transition duration-200 flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        <span>Export All Data to CSV</span>
                    </button>
                </div>

                <!-- Summary Card - Changes based on the active view -->
                <div id="summary-card" class="bg-indigo-700 text-white p-6 rounded-xl shadow-lg">
                    <!-- Dynamic content will be injected here -->
                </div>

            </div>

            <!-- Right Column: View Containers -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- 1. SESSIONAL MONITOR VIEW (100L Alpha/Omega) -->
                <div id="sessional-view-container">
                    
                    <!-- ALPHA SEMESTER TABLE (100 Level) -->
                    <div class="bg-white rounded-xl shadow-md mb-8" id="100-alpha-semester-container">
                        <div class="p-6 border-b border-gray-200 bg-gray-50 rounded-t-xl">
                            <h2 class="text-xl font-bold text-gray-800">100 Level: Alpha Semester Scores (1st)</h2>
                            <p class="text-sm text-gray-600">Enter scores (Test 1: max 20, Test 2: max 20, Exam: max 60)</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th>S/N</th>
                                        <th>Course Code</th>
                                        <th>Course Title</th>
                                        <th>Units</th>
                                        <th>Test 1 (20)</th>
                                        <th>Test 2 (20)</th>
                                        <th>Exam (60)</th>
                                        <th>Total (100)</th>
                                        <th>Grade</th>
                                    </tr>
                                </thead>
                                <tbody id="100-alpha-course-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                                <tfoot class="bg-gray-100 font-semibold">
                                    <tr>
                                        <td colspan="3" class="text-right px-4 py-3">Semester Totals:</td>
                                        <td id="100-alpha-footer-total-units" class="px-4 py-3">0</td>
                                        <td colspan="4" class="text-right px-4 py-3 text-base font-bold text-blue-600">Semester GPA (SGPA):</td>
                                        <td id="100-alpha-footer-gpa" class="px-4 py-3 text-base font-bold text-blue-600">0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- OMEGA SEMESTER TABLE (100 Level) -->
                    <div class="bg-white rounded-xl shadow-md" id="100-omega-semester-container">
                        <div class="p-6 border-b border-gray-200 bg-gray-50 rounded-t-xl">
                            <h2 class="text-xl font-bold text-gray-800">100 Level: Omega Semester Scores (2nd)</h2>
                            <p class="text-sm text-gray-600">Enter scores (Test 1: max 20, Test 2: max 20, Exam: max 60)</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th>S/N</th>
                                        <th>Course Code</th>
                                        <th>Course Title</th>
                                        <th>Units</th>
                                        <th>Test 1 (20)</th>
                                        <th>Test 2 (20)</th>
                                        <th>Exam (60)</th>
                                        <th>Total (100)</th>
                                        <th>Grade</th>
                                    </tr>
                                </thead>
                                <tbody id="100-omega-course-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                                <tfoot class="bg-gray-100 font-semibold">
                                    <tr>
                                        <td colspan="3" class="text-right px-4 py-3">Semester Totals:</td>
                                        <td id="100-omega-footer-total-units" class="px-4 py-3">0</td>
                                        <td colspan="4" class="text-right px-4 py-3 text-base font-bold text-indigo-600">Semester GPA (SGPA):</td>
                                        <td id="100-omega-footer-gpa" class="px-4 py-3 text-base font-bold text-indigo-600">0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 2. DEGREE PROGRESS VIEW (100L-400L Summary) -->
                <div id="degree-view-container" class="hidden">
                    <div class="bg-white rounded-xl shadow-md">
                        <div class="p-6 border-b border-gray-200 bg-gray-50 rounded-t-xl">
                            <h2 class="text-xl font-bold text-gray-800">Cumulative Degree Performance</h2>
                            <p class="text-sm text-gray-600">Summary of all academic levels (100L - 400L).</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="w-1/4">Academic Level</th>
                                        <th class="text-center">Total Units Earned</th>
                                        <th class="text-center">Level CGPA</th>
                                        <th class="text-center">Total Grade Points</th>
                                    </tr>
                                </thead>
                                <tbody id="degree-summary-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Dynamic rows for 100L, 200L, 300L, 400L -->
                                </tbody>
                                <tfoot class="bg-gray-100 font-extrabold text-lg">
                                    <tr>
                                        <td class="px-4 py-4 text-gray-900">Overall Cumulative CGPA:</td>
                                        <td id="final-units" class="text-center text-indigo-700">0</td>
                                        <td id="final-cgpa" class="text-center text-indigo-700">0.00</td>
                                        <td id="final-points" class="text-center text-indigo-700">0.0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="p-6 text-sm text-gray-500 italic border-t">
                            Note: Placeholder course data has been generated for 200L, 300L, and 400L. You must update the data structures in the JavaScript code to reflect your actual courses and enter scores as you progress.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA TEMPLATES ---

        // Helper to generate generic placeholder courses for higher levels
        const generatePlaceholderCourses = (level, units) => {
            const courses = [];
            for (let i = 1; i <= 10; i++) {
                courses.push({
                    id: level * 1000 + i,
                    sn: i,
                    code: `COS${level * 100 + (i < 10 ? '0' : '') + i}`,
                    title: `Placeholder Course ${level * 100 + i}`,
                    units: units,
                    test1: null,
                    test2: null,
                    exam: null
                });
            }
            return courses;
        };

        const courseTemplates = {
            '100-alpha': [
                { id: 101, sn: 1, code: 'GST112A', title: 'Communication in English II', units: 2, test1: null, test2: null, exam: null },
                { id: 102, sn: 2, code: 'LMU-COS112', title: 'Intro to Internet Technologies', units: 2, test1: null, test2: null, exam: null },
                { id: 103, sn: 3, code: 'COS102', title: 'Intro to Computer Programming', units: 3, test1: null, test2: null, exam: null },
                { id: 104, sn: 4, code: 'MTH102', title: 'Elementary Mathematics II', units: 2, test1: null, test2: null, exam: null },
                { id: 105, sn: 5, code: 'PHY102', title: 'General Physics II', units: 2, test1: null, test2: null, exam: null },
                { id: 106, sn: 6, code: 'PHY108', title: 'General Physics Practical II', units: 1, test1: null, test2: null, exam: null },
            ],
            '100-omega': [
                { id: 1, sn: 1, code: 'GST111A', title: 'Communication in English I', units: 2, test1: null, test2: null, exam: null },
                { id: 2, sn: 2, code: 'ITE111', title: 'IT Essentials', units: 0, test1: null, test2: null, exam: null },
                { id: 3, sn: 3, code: 'COS101', title: 'Introduction to Computing Sciences', units: 3, test1: null, test2: null, exam: null },
                { id: 4, sn: 4, code: 'LMU-COS111', title: 'Computer Science and the Society', units: 2, test1: null, test2: null, exam: null },
                { id: 5, sn: 5, code: 'LMU-CST111', title: 'Use of Library, Study Skills...', units: 2, test1: null, test2: null, exam: null },
                { id: 6, sn: 6, code: 'LMU-TMC111', title: 'Total Man Concept I', units: 1, test1: null, test2: null, exam: null },
                { id: 7, sn: 7, code: 'MTH101', title: 'Elementary Mathematics I', units: 2, test1: null, test2: null, exam: null },
            ],
            '200-alpha': generatePlaceholderCourses(2, 3),
            '200-omega': generatePlaceholderCourses(2, 2),
            '300-alpha': generatePlaceholderCourses(3, 3),
            '300-omega': generatePlaceholderCourses(3, 2),
            '400-alpha': generatePlaceholderCourses(4, 4),
            '400-omega': generatePlaceholderCourses(4, 3),
        };

        const gradingScale = [
            { score: 70, grade: 'A', points: 5 },
            { score: 60, grade: 'B', points: 4 },
            { score: 50, grade: 'C', points: 3 },
            { score: 45, grade: 'D', points: 2 },
            { score: 40, grade: 'E', points: 1 },
            { score: 0, grade: 'F', points: 0 }
        ];

        // --- STATE ---
        let degreeData = {}; 
        let activeSemesterId = '100-omega'; 
        let currentView = 'sessional'; // 'sessional' or 'degree'

        // All semesters keys
        const allSemesterIds = [
            '100-alpha', '100-omega', 
            '200-alpha', '200-omega', 
            '300-alpha', '300-omega', 
            '400-alpha', '400-omega'
        ];

        // --- CORE FUNCTIONS ---

        /**
         * Initializes the application when the DOM is loaded.
         */
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            
            // Render all tables initially (only 100L will be visible)
            allSemesterIds.forEach(id => {
                if (degreeData[id]) {
                    renderTable(id, degreeData[id]);
                }
            });

            // Set initial active selector and view
            document.getElementById('semester-select').value = activeSemesterId;
            switchView(currentView, false); 
            
            // Add event listeners for 100L input only (others are placeholders)
            document.getElementById('100-alpha-semester-container').addEventListener('input', (e) => handleScoreInput(e, '100-alpha'));
            document.getElementById('100-omega-semester-container').addEventListener('input', (e) => handleScoreInput(e, '100-omega'));
            document.getElementById('semester-select').addEventListener('change', handleSemesterChange);
        });

        /**
         * Loads data from localStorage or sets initial data.
         */
        function loadData() {
            const savedData = localStorage.getItem('csDegreeProgressData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                degreeData = parsedData.data;
                activeSemesterId = parsedData.activeId || '100-omega';
                currentView = parsedData.view || 'sessional';
            } else {
                // Initialize state from templates for all semesters
                const initializeSemester = (template) => template.map(course => ({
                    ...course,
                    total: 0,
                    grade: '-',
                    gradePoints: 0,
                    totalGradePoints: 0,
                    score: { test1: null, test2: null, exam: null } 
                }));
                
                allSemesterIds.forEach(id => {
                    degreeData[id] = initializeSemester(courseTemplates[id]);
                });
            }
        }

        /**
         * Saves the current degreeData state to localStorage.
         */
        function saveData() {
            localStorage.setItem('csDegreeProgressData', JSON.stringify({ 
                data: degreeData, 
                activeId: activeSemesterId,
                view: currentView
            }));
        }

        /**
         * Toggles between the Sessional Monitor and Degree Progress views.
         */
        function switchView(viewId, shouldSave = true) {
            currentView = viewId;
            const sessionalContainer = document.getElementById('sessional-view-container');
            const degreeContainer = document.getElementById('degree-view-container');
            const tabs = document.querySelectorAll('.tab-button');
            const sessionalControls = document.getElementById('sessional-controls');

            tabs.forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab-${viewId}`).classList.add('active');

            if (viewId === 'sessional') {
                sessionalContainer.classList.remove('hidden');
                degreeContainer.classList.add('hidden');
                sessionalControls.classList.remove('hidden');
                // Hide non-active 100L semester table
                document.getElementById('100-alpha-semester-container').classList.add('hidden');
                document.getElementById('100-omega-semester-container').classList.add('hidden');
                document.getElementById(activeSemesterId.replace('-', '-')).classList.remove('hidden');

            } else { // degree view
                sessionalContainer.classList.add('hidden');
                degreeContainer.classList.remove('hidden');
                sessionalControls.classList.add('hidden');
            }

            calculateAndUpdateSummary();
            if (shouldSave) saveData();
        }

        /**
         * Handles change in the semester dropdown selector.
         */
        function handleSemesterChange(event) {
            activeSemesterId = event.target.value;
            saveData();
            
            // Toggle visibility of the 100L tables
            document.getElementById('100-alpha-semester-container').classList.add('hidden');
            document.getElementById('100-omega-semester-container').classList.add('hidden');
            document.getElementById(activeSemesterId.replace('-', '-')).classList.remove('hidden');

            calculateAndUpdateSummary();
        }

        /**
         * Renders a specific course table.
         */
        function renderTable(semesterId, courses) {
            const tableBody = document.getElementById(`${semesterId}-course-table-body`);
            if (!tableBody) return;

            tableBody.innerHTML = ''; 
            const is100L = semesterId.startsWith('100');
            
            courses.forEach(course => {
                const tr = document.createElement('tr');
                tr.dataset.courseId = course.id;
                
                // Helper to check for null/undefined and return empty string
                const val = (field) => course.score[field] === null || typeof course.score[field] === 'undefined' ? '' : course.score[field];

                // Inputs are only generated for 100L, otherwise they are simple text
                const scoreInput = (type, max) => is100L 
                    ? `<input type="number" data-score-type="${type}" min="0" max="${max}" value="${val(type)}">`
                    : val(type) === '' ? '-' : val(type);


                tr.innerHTML = `
                    <td>${course.sn}</td>
                    <td class="font-medium">${course.code}</td>
                    <td>${course.title}</td>
                    <td class="font-semibold">${course.units}</td>
                    <td>${scoreInput('test1', 20)}</td>
                    <td>${scoreInput('test2', 20)}</td>
                    <td>${scoreInput('exam', 60)}</td>
                    <td data-output-type="total" class="font-bold">0</td>
                    <td data-output-type="grade" class="font-bold text-lg">-</td>
                `;
                tableBody.appendChild(tr);

                // Perform initial calculation for this row
                calculateAndUpdateRow(semesterId, course, tr);
            });
        }

        /**
         * Handles input events from the score fields.
         */
        function handleScoreInput(event, semesterId) {
            const input = event.target;
            if (input.tagName !== 'INPUT') return; 

            const row = input.closest('tr');
            const courseId = parseInt(row.dataset.courseId);
            const scoreType = input.dataset.scoreType;
            
            let value = input.value === '' ? null : parseInt(input.value);

            // Validate and clamp score
            const maxScore = { test1: 20, test2: 20, exam: 60 };
            if (value !== null) {
                value = Math.max(0, Math.min(maxScore[scoreType], value));
                input.value = value;
            }

            // Update the data model
            const course = degreeData[semesterId].find(c => c.id === courseId);
            course.score[scoreType] = value;

            // Recalculate and update the row and summary
            calculateAndUpdateRow(semesterId, course, row);
            calculateAndUpdateSummary();
            saveData();
        }

        /**
         * Calculates the total, grade, and grade points for a single course and updates its row in the DOM.
         */
        function calculateAndUpdateRow(semesterId, course, rowElement) {
            const { test1, test2, exam } = course.score;
            
            if (test1 !== null && test2 !== null && exam !== null) {
                course.total = test1 + test2 + exam;
                const gradeInfo = getGrade(course.total);
                course.grade = gradeInfo.grade;
                course.gradePoints = course.units > 0 ? gradeInfo.points : 0; 
                course.totalGradePoints = course.gradePoints * course.units;
            } else {
                course.total = 0;
                course.grade = '-';
                course.gradePoints = 0;
                course.totalGradePoints = 0;
            }

            // Update the DOM
            if(rowElement) {
                rowElement.querySelector('[data-output-type="total"]').innerText = course.total;
                const gradeCell = rowElement.querySelector('[data-output-type="grade"]');
                gradeCell.innerText = course.grade;
                
                // Add color to grade
                gradeCell.className = 'font-bold text-lg'; // Reset classes
                if (course.grade === 'A') gradeCell.classList.add('text-green-600');
                else if (course.grade === 'B') gradeCell.classList.add('text-blue-600');
                else if (course.grade === 'C') gradeCell.classList.add('text-yellow-600');
                else if (course.grade === 'D' || course.grade === 'E') gradeCell.classList.add('text-orange-600');
                else if (course.grade === 'F') gradeCell.classList.add('text-red-600');
            }
        }

        /**
         * Calculates and returns summary object for a single semester.
         */
        function calculateSemesterSummary(semesterCourses) {
            let totalRegisteredUnits = 0;
            let totalEarnedGradePoints = 0;
            let unitsForGpaCalc = 0; 

            for (const course of semesterCourses) {
                totalRegisteredUnits += course.units;
                
                // Only include courses that have been graded (total is calculated) AND have units > 0
                if (course.grade !== '-' && course.units > 0) {
                    totalEarnedGradePoints += (course.gradePoints * course.units);
                    unitsForGpaCalc += course.units;
                }
            }

            const gpa = unitsForGpaCalc > 0 ? (totalEarnedGradePoints / unitsForGpaCalc) : 0;

            return {
                totalRegisteredUnits,
                totalEarnedGradePoints,
                unitsForGpaCalc,
                gpa
            };
        }

        /**
         * Calculates the overall CGPA across all levels/semesters.
         */
        function calculateDegreeCGPA() {
            let overallTotalGradePoints = 0;
            let overallUnitsForDivision = 0;
            const levelSummaries = {};

            // Iterate through all 8 semesters
            const levels = ['100', '200', '300', '400'];

            levels.forEach(level => {
                const alphaSummary = calculateSemesterSummary(degreeData[`${level}-alpha`]);
                const omegaSummary = calculateSemesterSummary(degreeData[`${level}-omega`]);

                // Level-based aggregation
                const levelTotalPoints = alphaSummary.totalEarnedGradePoints + omegaSummary.totalEarnedGradePoints;
                const levelTotalUnits = alphaSummary.unitsForGpaCalc + omegaSummary.unitsForGpaCalc;
                const levelCGPA = levelTotalUnits > 0 ? (levelTotalPoints / levelTotalUnits) : 0;

                levelSummaries[level] = {
                    units: alphaSummary.totalRegisteredUnits + omegaSummary.totalRegisteredUnits,
                    points: levelTotalPoints,
                    cgpa: levelCGPA
                };

                // Overall aggregation
                overallTotalGradePoints += levelTotalPoints;
                overallUnitsForDivision += levelTotalUnits;
            });

            const overallCGPA = overallUnitsForDivision > 0 ? (overallTotalGradePoints / overallUnitsForDivision) : 0;
            
            return {
                levels: levelSummaries,
                overallCGPA: overallCGPA,
                overallTotalGradePoints: overallTotalGradePoints,
                overallTotalUnits: overallUnitsForDivision
            };
        }

        /**
         * Calculates and updates all summary statistics based on the current view.
         */
        function calculateAndUpdateSummary() {
            const { levels, overallCGPA, overallTotalGradePoints, overallTotalUnits } = calculateDegreeCGPA();
            const summaryCard = document.getElementById('summary-card');

            // --- 1. Update Footers for 100L Tables ---
            const alpha100 = calculateSemesterSummary(degreeData['100-alpha']);
            const omega100 = calculateSemesterSummary(degreeData['100-omega']);
            
            document.getElementById('100-alpha-footer-total-units').innerText = alpha100.totalRegisteredUnits;
            document.getElementById('100-alpha-footer-gpa').innerText = alpha100.gpa.toFixed(2);
            document.getElementById('100-omega-footer-total-units').innerText = omega100.totalRegisteredUnits;
            document.getElementById('100-omega-footer-gpa').innerText = omega100.gpa.toFixed(2);


            if (currentView === 'sessional') {
                // --- 2. Update Sessional Summary Card (100L) ---
                const activeId = activeSemesterId;
                const activeSummary = activeId.endsWith('alpha') ? alpha100 : omega100;
                const activeTitle = activeId === '100-alpha' ? '100L Alpha Semester Summary' : '100L Omega Semester Summary';

                summaryCard.className = 'bg-indigo-700 text-white p-6 rounded-xl shadow-lg';
                summaryCard.innerHTML = `
                    <div class="text-sm font-medium text-indigo-200 mb-2">${activeTitle}</div>
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <div class="text-sm font-medium text-indigo-200 mb-1">Semester GPA</div>
                            <div class="text-4xl font-bold">${activeSummary.gpa.toFixed(2)}</div>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-indigo-200 mb-1">Total Units</div>
                            <div class="text-4xl font-bold">${activeSummary.totalRegisteredUnits}</div>
                        </div>
                        <div class="col-span-2">
                            <div class="text-sm font-medium text-indigo-200 mb-1">Total Grade Points Earned</div>
                            <div class="text-3xl font-bold">${activeSummary.totalEarnedGradePoints.toFixed(1)}</div>
                        </div>
                    </div>
                `;
            } else {
                // --- 3. Update Degree Summary Card (Overall) ---
                const classification = getClass(overallCGPA);
                summaryCard.className = 'bg-green-700 text-white p-6 rounded-xl shadow-lg';
                summaryCard.innerHTML = `
                    <div class="text-sm font-medium text-green-200 mb-2">Overall Cumulative CGPA</div>
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <div class="text-sm font-medium text-green-200 mb-1">CGPA</div>
                            <div class="text-5xl font-extrabold">${overallCGPA.toFixed(2)}</div>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-green-200 mb-1">Classification</div>
                            <div class="text-2xl font-bold mt-2">${classification.name}</div>
                            <div class="text-xs text-green-300">${classification.range}</div>
                        </div>
                        <div class="col-span-2 mt-2">
                            <div class="text-sm font-medium text-green-200 mb-1">Total Units Carried / Total Grade Points</div>
                            <div class="text-xl font-bold">${overallTotalUnits} Units / ${overallTotalGradePoints.toFixed(1)} Points</div>
                        </div>
                    </div>
                `;

                // --- 4. Update Degree Progress Table ---
                const tableBody = document.getElementById('degree-summary-body');
                tableBody.innerHTML = '';
                const levelsArr = [100, 200, 300, 400];
                
                levelsArr.forEach(level => {
                    const data = levels[String(level)];
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-4 py-4 font-semibold">${level} Level</td>
                        <td class="text-center">${data.units}</td>
                        <td class="text-center font-bold text-lg">${data.cgpa.toFixed(2)}</td>
                        <td class="text-center">${data.points.toFixed(1)}</td>
                    `;
                    tableBody.appendChild(tr);
                });

                document.getElementById('final-units').innerText = overallTotalUnits;
                document.getElementById('final-cgpa').innerText = overallCGPA.toFixed(2);
                document.getElementById('final-points').innerText = overallTotalGradePoints.toFixed(1);
            }
        }

        /**
         * Returns the grade and points for a given total score.
         */
        function getGrade(score) {
            for (const scale of gradingScale) {
                if (score >= scale.score) {
                    return { grade: scale.grade, points: scale.points };
                }
            }
            return { grade: 'F', points: 0 }; // Default
        }

        /**
         * Returns the Degree Classification based on CGPA. (Standard Nigerian University classification)
         */
        function getClass(cgpa) {
            if (cgpa >= 4.50) return { name: 'First Class Honours', range: '4.50 - 5.00' };
            if (cgpa >= 3.50) return { name: 'Second Class Honours (Upper Division)', range: '3.50 - 4.49' };
            if (cgpa >= 2.40) return { name: 'Second Class Honours (Lower Division)', range: '2.40 - 3.49' };
            if (cgpa >= 1.50) return { name: 'Third Class Honours', range: '1.50 - 2.39' };
            if (cgpa >= 1.00) return { name: 'Pass', range: '1.00 - 1.49' };
            return { name: 'Fail / No Result', range: 'Below 1.00' };
        }

        /**
         * Export ALL 8 semesters of data and the overall summary to a CSV file.
         */
        function exportResultsToCSV() {
            const { levels, overallCGPA, overallTotalGradePoints, overallTotalUnits } = calculateDegreeCGPA();
            const csvRows = [];
            const separator = ',';

            // --- Section 1: Overall Degree Summary ---
            csvRows.push('Cumulative Degree Performance Report' + separator.repeat(8));
            csvRows.push(''); 
            csvRows.push('Metric,Value');
            csvRows.push(`Overall CGPA,${overallCGPA.toFixed(2)}`);
            csvRows.push(`Overall Grade Points,${overallTotalGradePoints.toFixed(1)}`);
            csvRows.push(`Overall Units Carried,${overallTotalUnits}`);
            csvRows.push(`Classification,"${getClass(overallCGPA).name}"`);
            csvRows.push('');

            // --- Section 2: Level Summaries ---
            csvRows.push('Academic Level Summary');
            csvRows.push('Level,CGPA,Total Units,Total Grade Points');
            for (const level in levels) {
                const data = levels[level];
                csvRows.push(`${level} Level,${data.cgpa.toFixed(2)},${data.units},${data.points.toFixed(1)}`);
            }
            csvRows.push(''); 

            // --- Section 3: Detailed Semester Breakdown ---
            csvRows.push('Detailed Semester Breakdown');
            csvRows.push('Semester,S/N,Course Code,Course Title,Units,Test 1 (20),Test 2 (20),Exam (60),Total Score,Grade,Grade Points');
            
            allSemesterIds.forEach(id => {
                degreeData[id].forEach(course => {
                    const level = id.split('-')[0];
                    const semesterName = id.split('-')[1] === 'alpha' ? 'Alpha (1st)' : 'Omega (2nd)';
                    const fullSemester = `${level}L ${semesterName}`;

                    const row = [
                        fullSemester,
                        course.sn,
                        course.code,
                        `"${course.title.replace(/"/g, '""')}"`, // Handle commas in titles
                        course.units,
                        course.score.test1 ?? '',
                        course.score.test2 ?? '',
                        course.score.exam ?? '',
                        course.total,
                        course.grade,
                        (course.gradePoints * course.units).toFixed(1)
                    ];
                    csvRows.push(row.join(separator));
                });
                csvRows.push(''); // Add a gap between semesters
            });

            // Create Blob and link for download
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            // Generate a filename
            const date = new Date().toISOString().slice(0, 10);
            link.download = `CS_Degree_Report_${date}.csv`;
            link.href = URL.createObjectURL(blob);
            link.style.visibility = 'hidden';
            
            // Append and click the link to trigger the download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>
